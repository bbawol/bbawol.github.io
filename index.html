<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2025 A2 STEAM Winter Arts Market</title>
  <style>
    body {
      background-color: #f0f8ff;
      font-family: Arial, sans-serif;
      color: #333;
      padding: 20px;
    }

    #fundraiserForm {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      max-width: 600px;
      margin: 0 auto;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: calc(100% - 20px);
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      background-color: #007bff;
      color: #fff;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px 0;
    }

    button:hover {
      background-color: #0056b3;
    }

    label {
      font-weight: bold;
    }
  </style>
</head>

<body>
  <h1 style="text-align:center;">2025 A2 STEAM Winter Arts Market</h1>
  <form id="fundraiserForm">
    <div id="dataEntryPersonContainer" style="max-width:600px;margin:0 auto 15px;">
      <label>Data Entry Person:</label>
      <div id="dataEntryPersonView">
        <strong id="dataEntryPersonDisplay"></strong>
        <a href="#" id="editDataEntryPersonLink" style="margin-left:8px;">Edit</a>
      </div>
      <div id="dataEntryPersonEdit" style="margin-top:8px; display:none;">
        <input type="text" id="dataEntryPersonInput" placeholder="Enter your name" style="width: calc(100% - 20px); padding: 8px;">
        <button type="button" id="saveDataEntryPersonButton">Save</button>
      </div>
    </div>
    <label for="shopperId">Shopper ID:</label>
    <input type="text" id="shopperId" name="shopperId" required><br><br>
    <div id="artistsContainer">
      <div class="artistSection">
        <label for="artistId">Artist:</label>
        <select class="artistId" name="artistId" required></select><br><br>
        <label>Amount:</label>
        <input type="number" class="productAmount" name="productAmount" step="0.01" required><br><br>
        <button type="button" onclick="deleteArtistSection(this)" style="display: none;">Delete Artist</button><br><br>
        <button type="button" onclick="refreshArtists()">Refresh Artist List</button>
      </div>
    </div>
    <button type="button" onclick="addArtistSection()">Add Another Artist</button><br><br>

    <label>Total: $<span id="totalAmount">0.00</span></label><br><br>
    <button type="submit">Submit</button>
  </form>

  <h2 style="max-width:600px;margin:20px auto 10px;">Recent submissions (this device)</h2>
  <div id="recentSubmissions" style="max-width:600px;margin:0 auto 20px;"></div>

  <div id="grandTotalContainer" style="max-width:600px;margin:30px auto;">
    <h2>Grand Total (ACTIVE sales)</h2>
    <div style="margin-bottom:8px;">
      $<span id="grandTotalValue">0.00</span> of $10,000 goal
    </div>
    <div style="background:#eee;border-radius:8px;overflow:hidden;height:24px;">
      <div id="grandTotalBar" style="height:100%;width:0%;background:#28a745;transition:width 0.5s;"></div>
    </div>
  </div>

  <script>
  let isSubmitting = false;
  let cachedArtists = null;

  const RECENT_SUBMISSIONS_KEY = 'winterArtsRecentSubmissions';
  const SCRIPT_BASE_URL = 'https://script.google.com/macros/s/AKfycbxmAKt57E_4wIejDyPZBubyReLROfP5lYKPRuNSy3BSgdvyEOccfYheRSn3lh4DbFoL/exec';
  const DATA_ENTRY_NAME_KEY = 'winterArtsDataEntryPerson';
  const GOAL_AMOUNT = 10000;

  document.addEventListener('DOMContentLoaded', function () {
    fetchArtists();
    loadRecentSubmissions();
    initDataEntryPerson();
    fetchGrandTotal();     // NEW
  });

  function fetchArtists(selectElementToPopulate = null, forceRefresh = false) {
    // If we already have artists cached and not forcing refresh, reuse them
    if (cachedArtists && !forceRefresh) {
      if (selectElementToPopulate) {
        populateSelectElement(selectElementToPopulate, cachedArtists);
      } else {
        const artistSelectElements = document.querySelectorAll('.artistId');
        artistSelectElements.forEach(selectElement => {
          populateSelectElement(selectElement, cachedArtists);
        });
      }
      return;
    }

    // Otherwise, fetch from Apps Script
    fetch(`${SCRIPT_BASE_URL}?action=getArtists`)
      .then(response => response.json())
      .then(artists => {
        artists.sort();
        cachedArtists = artists; // cache them

        if (selectElementToPopulate) {
          populateSelectElement(selectElementToPopulate, artists);
        } else {
          const artistSelectElements = document.querySelectorAll('.artistId');
          artistSelectElements.forEach(selectElement => {
            populateSelectElement(selectElement, artists);
          });
        }
      })
      .catch(error => {
        console.error('Error fetching artists:', error);
      });
  }

  function populateSelectElement(selectElement, artists) {
    selectElement.innerHTML = ''; // Clear the existing options
    artists.forEach(artistCode => {
      const option = document.createElement('option');
      option.value = artistCode;
      option.textContent = artistCode;
      selectElement.appendChild(option);
    });
  }

  function addArtistSection() {
    const artistsContainer = document.getElementById('artistsContainer');
    const artistSection = document.createElement('div');
    artistSection.classList.add('artistSection');
    artistSection.innerHTML = `
      <label for="artistId">Artist:</label>
      <select class="artistId" name="artistId" required></select><br><br>

      <label>Amount:</label>
      <input type="number" class="productAmount" name="productAmount" step="0.01" required><br><br>
      <button type="button" onclick="deleteArtistSection(this)" style="display: none;">Delete Artist</button><br><br>
    `;
    artistsContainer.appendChild(artistSection);

    // Populate the newly added artist dropdown only
    const newSelectElement = artistSection.querySelector('.artistId');
    fetchArtists(newSelectElement);
  }

  function deleteArtistSection(button) {
    const artistSection = button.parentElement;
    artistSection.parentElement.removeChild(artistSection);
    updateTotal();
    toggleArtistDeleteButtons();
  }

  document.getElementById('fundraiserForm').addEventListener('input', updateTotal);
  document.getElementById('fundraiserForm').addEventListener('input', toggleArtistDeleteButtons);

  function updateTotal() {
    let total = 0;
    const amounts = document.getElementsByClassName('productAmount');
    for (let i = 0; i < amounts.length; i++) {
      total += parseFloat(amounts[i].value || 0);
    }
    document.getElementById('totalAmount').innerText = total.toFixed(2);
  }

  function toggleArtistDeleteButtons() {
    const artistSections = document.getElementsByClassName('artistSection');
    for (let i = 0; i < artistSections.length; i++) {
      const artistId = artistSections[i].querySelector('.artistId');
      const deleteArtistButton = artistSections[i].querySelector('button[onclick="deleteArtistSection(this)"]');
      if (artistId.value.trim() !== '') {
        deleteArtistButton.style.display = 'inline-block';
      } else {
        deleteArtistButton.style.display = 'none';
      }
    }
  }

  document.getElementById('fundraiserForm').addEventListener('submit', function (e) {
    e.preventDefault(); // Prevent the form from submitting the normal way

    // --- prevent double submit ---
    if (isSubmitting) {
      // Ignore extra clicks while a submit is in progress
      return;
    }
    isSubmitting = true;

    const submitButton = this.querySelector('button[type="submit"]');
    const originalButtonText = submitButton.textContent;
    submitButton.disabled = true;
    submitButton.textContent = 'Submitting…';

    // Get form data
    const shopperId = document.getElementById('shopperId').value;
    const artistSections = document.getElementsByClassName('artistSection');

    const dataEntryName = getDataEntryPersonName();
    if (!dataEntryName) {
      if (!confirm('No Data Entry Person name is set. Continue anyway?')) {
        isSubmitting = false;
        submitButton.disabled = false;
        submitButton.textContent = originalButtonText;
        return;
      }
    }

    // Optional: guard against zero total
    if (artistSections.length === 0) {
      alert('Please add at least one artist.');
      isSubmitting = false;
      submitButton.disabled = false;
      submitButton.textContent = originalButtonText;
      return;
    }

    const totalText = document.getElementById('totalAmount').innerText;
    const total = parseFloat(totalText) || 0;
    if (total <= 0) {
      alert('Total must be greater than zero.');
      isSubmitting = false;
      submitButton.disabled = false;
      submitButton.textContent = originalButtonText;
      return;
    }

    // Prepare query parameters
    let params = new URLSearchParams();
    params.append('action', 'submitForm');
    params.append('shopperId', shopperId);
    params.append('dataEntryPerson', dataEntryName); // NEW

    // Generate a unique submissionId to help the backend de-duplicate
    const submissionId = 'sub_' + Date.now() + '_' + Math.random().toString(36).slice(2, 8);
    params.append('submissionId', submissionId);

    // Build summary for recent submissions panel
    const itemsForSummary = [];

    // Loop through each artist section and add them as query parameters
    for (let i = 0; i < artistSections.length; i++) {
      const artistId = artistSections[i].querySelector('.artistId').value;
      const productAmountStr = artistSections[i].querySelector('.productAmount').value;
      const productAmountNum = parseFloat(productAmountStr || '0') || 0;

      params.append('artistId', artistId);
      params.append('productAmount', productAmountNum.toString());

      itemsForSummary.push({
        artistId: artistId,
        amount: productAmountNum
      });
    }

    // Construct the GET request URL
    const url = `${SCRIPT_BASE_URL}?${params.toString()}`;

    // Make the GET request
    fetch(url, {
      method: 'GET',
    })
      .then(response => {
        if (!response.ok) {
          throw new Error("HTTP error " + response.status);
        }
        return response.text(); // keep as text so you don't have to change Apps Script yet
      })
      .then(result => {
        console.log('Server result:', result);

        if (result === 'duplicate') {
          alert('This transaction was already submitted. No new rows were added.');
          // In a duplicate case, don’t clear the form
          return;
        }

        if (result.startsWith('Error')) {
          alert('The server reported an error: ' + result);
          return;
        }

        // Normal success
        alert('Form submitted successfully!');

        fetchGrandTotal();

        // Save this submission locally for the "recent submissions" panel
        rememberSubmission({
          submissionId: submissionId,
          shopperId: shopperId,
          total: total,
          items: itemsForSummary,
          createdAt: new Date().toISOString(),
          deleted: false
        });

        // Clear form fields
        document.getElementById('shopperId').value = '';
        const artistsContainer = document.getElementById('artistsContainer');
        artistsContainer.innerHTML = '';

        // Re-add the initial blank artist section
        addArtistSection();

        // Reset the total amount
        document.getElementById('totalAmount').innerText = '0.00';
      })
      .catch(error => {
        alert('There was an error submitting the form.');
        console.error('Error:', error);
      })
      .finally(() => {
        // Re-enable the button and clear the submitting flag
        isSubmitting = false;
        submitButton.disabled = false;
        submitButton.textContent = originalButtonText;
      });
  });

  // ===== Recent submissions helpers =====

  function loadRecentSubmissions() {
    let list = [];
    try {
      const stored = localStorage.getItem(RECENT_SUBMISSIONS_KEY);
      if (stored) {
        const parsed = JSON.parse(stored);
        if (Array.isArray(parsed)) {
          list = parsed;
        }
      }
    } catch (err) {
      console.error("Error loading recent submissions from localStorage:", err);
    }
    renderRecentSubmissions(list);
  }

  function rememberSubmission(summary) {
    let list = [];
    try {
      const stored = localStorage.getItem(RECENT_SUBMISSIONS_KEY);
      if (stored) {
        const parsed = JSON.parse(stored);
        if (Array.isArray(parsed)) {
          list = parsed;
        }
      }
    } catch (err) {
      console.error("Error reading recent submissions from localStorage:", err);
    }

    // Add new one to front
    list.unshift(summary);
    // Keep only last 10
    list = list.slice(0, 10);

    localStorage.setItem(RECENT_SUBMISSIONS_KEY, JSON.stringify(list));
    renderRecentSubmissions(list);
  }

  function renderRecentSubmissions(list) {
    const container = document.getElementById('recentSubmissions');
    if (!container) return;

    if (!list || list.length === 0) {
      container.innerHTML = '<em>No recent submissions on this device yet.</em>';
      return;
    }

    let html = '<table style="width:100%;border-collapse:collapse;font-size:0.9rem;">';
    html += '<thead><tr>' +
      '<th style="border-bottom:1px solid #ccc;text-align:left;padding:4px;">Time</th>' +
      '<th style="border-bottom:1px solid #ccc;text-align:left;padding:4px;">Shopper</th>' +
      '<th style="border-bottom:1px solid #ccc;text-align:left;padding:4px;">Total</th>' +
      '<th style="border-bottom:1px solid #ccc;text-align:left;padding:4px;">Artists</th>' +
      '<th style="border-bottom:1px solid #ccc;text-align:left;padding:4px;">Action</th>' +
      '</tr></thead><tbody>';

    list.forEach(entry => {
      const dateStr = entry.createdAt
        ? new Date(entry.createdAt).toLocaleString()
        : '';

      const artistsText = (entry.items || [])
        .map(item => `${item.artistId}: $${item.amount.toFixed(2)}`)
        .join('<br>');

      const isDeleted = !!entry.deleted;

      const rowStyle = isDeleted
        ? 'opacity:0.6;text-decoration:line-through;'
        : '';

      let actionCell;
      if (isDeleted) {
        actionCell = '<span style="font-size:0.8rem;color:#888;">Deleted</span>';
      } else {
        actionCell = `<button type="button" onclick="softDeleteTransaction('${entry.submissionId}')">Mark deleted</button>`;
      }

      html += `<tr style="${rowStyle}">` +
        `<td style="border-bottom:1px solid #eee;vertical-align:top;padding:4px;">${dateStr}</td>` +
        `<td style="border-bottom:1px solid #eee;vertical-align:top;padding:4px;">${entry.shopperId || ''}</td>` +
        `<td style="border-bottom:1px solid #eee;vertical-align:top;padding:4px;">$${(entry.total || 0).toFixed(2)}</td>` +
        `<td style="border-bottom:1px solid #eee;vertical-align:top;padding:4px;">${artistsText}</td>` +
        `<td style="border-bottom:1px solid #eee;vertical-align:top;padding:4px;">${actionCell}</td>` +
        '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  }

  // Soft delete a transaction by submissionId (transactionId)
  function softDeleteTransaction(submissionId) {
    if (!confirm('Mark this entire transaction as deleted in the spreadsheet?')) {
      return;
    }

    const url = `${SCRIPT_BASE_URL}?action=softDelete&transactionId=${encodeURIComponent(submissionId)}`;

    fetch(url, { method: 'GET' })
      .then(response => {
        if (!response.ok) {
          throw new Error('HTTP error ' + response.status);
        }
        return response.text();
      })
      .then(result => {
        console.log('Soft delete result:', result);

        if (result === 'ok') {
          // Update localStorage entry to mark as deleted
          let list = [];
          try {
            const stored = localStorage.getItem(RECENT_SUBMISSIONS_KEY);
            if (stored) {
              const parsed = JSON.parse(stored);
              if (Array.isArray(parsed)) {
                list = parsed;
              }
            }
          } catch (err) {
            console.error('Error reading recent submissions from localStorage:', err);
          }

          let changed = false;
          list.forEach(entry => {
            if (entry.submissionId === submissionId) {
              entry.deleted = true;
              changed = true;
            }
          });

          if (changed) {
            localStorage.setItem(RECENT_SUBMISSIONS_KEY, JSON.stringify(list));
            renderRecentSubmissions(list);
          }

          alert('Transaction marked as deleted.');
          fetchGrandTotal();
        } else if (result === 'notfound') {
          alert('Transaction not found in spreadsheet.');
        } else {
          alert('Unexpected response from server: ' + result);
        }
      })
      .catch(err => {
        console.error('Error performing soft delete:', err);
        alert('There was an error marking this transaction as deleted.');
      });
  }

  function initDataEntryPerson() {
    const displayEl = document.getElementById('dataEntryPersonDisplay');
    const viewEl = document.getElementById('dataEntryPersonView');
    const editEl = document.getElementById('dataEntryPersonEdit');
    const inputEl = document.getElementById('dataEntryPersonInput');
    const saveBtn = document.getElementById('saveDataEntryPersonButton');
    const editLink = document.getElementById('editDataEntryPersonLink');

    if (!displayEl || !viewEl || !editEl) return;

    let storedName = localStorage.getItem(DATA_ENTRY_NAME_KEY) || '';

    function showViewMode() {
      if (storedName) {
        displayEl.textContent = storedName;
        viewEl.style.display = 'block';
        editEl.style.display = 'none';
      } else {
        // No name set yet – show edit mode by default
        viewEl.style.display = 'none';
        editEl.style.display = 'block';
        inputEl.value = '';
      }
    }

    function showEditMode() {
      inputEl.value = storedName || '';
      viewEl.style.display = 'none';
      editEl.style.display = 'block';
      inputEl.focus();
    }

    saveBtn.addEventListener('click', function () {
      const val = (inputEl.value || '').trim();
      if (!val) {
        alert('Please enter a name.');
        return;
      }
      storedName = val;
      localStorage.setItem(DATA_ENTRY_NAME_KEY, storedName);
      showViewMode();
    });

    editLink.addEventListener('click', function (e) {
      e.preventDefault();
      showEditMode();
    });

    showViewMode();
  }

  function getDataEntryPersonName() {
    return localStorage.getItem(DATA_ENTRY_NAME_KEY) || '';
  }

  function fetchGrandTotal() {
    const url = `${SCRIPT_BASE_URL}?action=getGrandTotal`;
    return fetch(url)
      .then(response => {
        if (!response.ok) throw new Error('HTTP ' + response.status);
        return response.text();
      })
      .then(text => {
        const amount = parseFloat(String(text).replace(/[^0-9.\-]/g, '')) || 0;
        updateGrandTotalUI(amount);
      })
      .catch(err => {
        console.error('Error fetching grand total:', err);
      });
  }

  function updateGrandTotalUI(amount) {
    const valEl = document.getElementById('grandTotalValue');
    const barEl = document.getElementById('grandTotalBar');
    if (valEl) valEl.textContent = amount.toFixed(2);

    if (barEl) {
      let pct = (amount / GOAL_AMOUNT) * 100;
      if (pct < 0) pct = 0;
      if (pct > 100) pct = 100;
      barEl.style.width = pct.toFixed(1) + '%';
    }
  }

  function refreshArtists() {
    cachedArtists = null;
    fetchArtists(null, true);
  }

</script>
  
</body>
</html>